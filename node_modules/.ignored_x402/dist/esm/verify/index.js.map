{"version":3,"sources":["../../../src/verify/useFacilitator.ts"],"sourcesContent":["import axios from \"axios\";\nimport { toJsonSafe } from \"../shared\";\nimport { FacilitatorConfig } from \"../types\";\nimport {\n  PaymentPayload,\n  PaymentRequirements,\n  SettleResponse,\n  VerifyResponse,\n} from \"../types/verify\";\n\nconst DEFAULT_FACILITATOR_URL = \"https://x402.org/facilitator\";\n\nexport type CreateHeaders = () => Promise<{\n  verify: Record<string, string>;\n  settle: Record<string, string>;\n}>;\n\n/**\n * Creates a facilitator client for interacting with the X402 payment facilitator service\n *\n * @param facilitator - The facilitator config to use. If not provided, the default facilitator will be used.\n * @returns An object containing verify and settle functions for interacting with the facilitator\n */\nexport function useFacilitator(facilitator?: FacilitatorConfig) {\n  /**\n   * Verifies a payment payload with the facilitator service\n   *\n   * @param payload - The payment payload to verify\n   * @param paymentRequirements - The payment requirements to verify against\n   * @returns A promise that resolves to the verification response\n   */\n  async function verify(\n    payload: PaymentPayload,\n    paymentRequirements: PaymentRequirements,\n  ): Promise<VerifyResponse> {\n    const url = facilitator?.url || DEFAULT_FACILITATOR_URL;\n\n    const res = await axios.post(\n      `${url}/verify`,\n      {\n        x402Version: payload.x402Version,\n        paymentPayload: toJsonSafe(payload),\n        paymentRequirements: toJsonSafe(paymentRequirements),\n      },\n      {\n        headers: facilitator?.createAuthHeaders\n          ? (await facilitator.createAuthHeaders()).verify\n          : undefined,\n      },\n    );\n\n    if (res.status !== 200) {\n      throw new Error(`Failed to verify payment: ${res.statusText}`);\n    }\n\n    return res.data as VerifyResponse;\n  }\n\n  /**\n   * Settles a payment with the facilitator service\n   *\n   * @param payload - The payment payload to settle\n   * @param paymentRequirements - The payment requirements for the settlement\n   * @returns A promise that resolves to the settlement response\n   */\n  async function settle(\n    payload: PaymentPayload,\n    paymentRequirements: PaymentRequirements,\n  ): Promise<SettleResponse> {\n    const url = facilitator?.url || DEFAULT_FACILITATOR_URL;\n\n    const res = await axios.post(\n      `${url}/settle`,\n      {\n        x402Version: payload.x402Version,\n        paymentPayload: toJsonSafe(payload),\n        paymentRequirements: toJsonSafe(paymentRequirements),\n      },\n      {\n        headers: facilitator?.createAuthHeaders\n          ? (await facilitator.createAuthHeaders()).settle\n          : undefined,\n      },\n    );\n\n    if (res.status !== 200) {\n      throw new Error(`Failed to settle payment: ${res.statusText}`);\n    }\n\n    return res.data as SettleResponse;\n  }\n\n  return { verify, settle };\n}\n\nexport const { verify, settle } = useFacilitator();\n"],"mappings":";;;;;;AAAA,OAAO,WAAW;AAUlB,IAAM,0BAA0B;AAazB,SAAS,eAAe,aAAiC;AAQ9D,iBAAeA,QACb,SACA,qBACyB;AACzB,UAAM,OAAM,2CAAa,QAAO;AAEhC,UAAM,MAAM,MAAM,MAAM;AAAA,MACtB,GAAG,GAAG;AAAA,MACN;AAAA,QACE,aAAa,QAAQ;AAAA,QACrB,gBAAgB,WAAW,OAAO;AAAA,QAClC,qBAAqB,WAAW,mBAAmB;AAAA,MACrD;AAAA,MACA;AAAA,QACE,UAAS,2CAAa,sBACjB,MAAM,YAAY,kBAAkB,GAAG,SACxC;AAAA,MACN;AAAA,IACF;AAEA,QAAI,IAAI,WAAW,KAAK;AACtB,YAAM,IAAI,MAAM,6BAA6B,IAAI,UAAU,EAAE;AAAA,IAC/D;AAEA,WAAO,IAAI;AAAA,EACb;AASA,iBAAeC,QACb,SACA,qBACyB;AACzB,UAAM,OAAM,2CAAa,QAAO;AAEhC,UAAM,MAAM,MAAM,MAAM;AAAA,MACtB,GAAG,GAAG;AAAA,MACN;AAAA,QACE,aAAa,QAAQ;AAAA,QACrB,gBAAgB,WAAW,OAAO;AAAA,QAClC,qBAAqB,WAAW,mBAAmB;AAAA,MACrD;AAAA,MACA;AAAA,QACE,UAAS,2CAAa,sBACjB,MAAM,YAAY,kBAAkB,GAAG,SACxC;AAAA,MACN;AAAA,IACF;AAEA,QAAI,IAAI,WAAW,KAAK;AACtB,YAAM,IAAI,MAAM,6BAA6B,IAAI,UAAU,EAAE;AAAA,IAC/D;AAEA,WAAO,IAAI;AAAA,EACb;AAEA,SAAO,EAAE,QAAAD,SAAQ,QAAAC,QAAO;AAC1B;AAEO,IAAM,EAAE,QAAQ,OAAO,IAAI,eAAe;","names":["verify","settle"]}